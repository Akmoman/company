<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>نظام فوترة الموردين المطور</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+Arabic:wght@300;400;600;700&display=swap" rel="stylesheet">

    <style>
        body { font-family: 'Noto Sans Arabic', sans-serif; }
        @media print {
            .no-print { display: none !important; }
            .print-only { display: block !important; }
            body, main { background: white; height: auto; overflow: visible; }
            .card { box-shadow: none; border: none; }
            table { width: 100%; border: 1px solid #ddd; }
            th, td { border: 1px solid #ddd; padding: 8px; font-size: 12px; }
            .print-break-inside { break-inside: avoid; }
        }
        /* Custom Scrollbar for tables */
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
    </style>
</head>
<body class="bg-gray-50 text-gray-800">

    <!-- Login Screen -->
    <div id="login-screen" class="fixed inset-0 bg-gray-900 z-50 flex items-center justify-center flex-col gap-4 no-print">
        <div class="bg-white p-8 rounded-xl shadow-2xl w-full max-w-md text-center mx-4">
            <div class="bg-blue-600 p-4 rounded-full w-fit mx-auto mb-6 shadow-lg">
                <i data-lucide="lock" class="text-white w-8 h-8"></i>
            </div>
            <h2 class="text-2xl font-bold text-gray-800 mb-2">تسجيل الدخول</h2>
            <p class="text-gray-500 mb-6 text-sm">أدخل رمز المرور للدخول</p>
            <form id="login-form" class="space-y-6">
                <input type="password" id="login-password" placeholder="الرمز" class="w-full p-4 border border-gray-300 rounded-lg text-center text-xl tracking-widest focus:ring-2 focus:ring-blue-500 outline-none" required autofocus>
                <button type="submit" class="w-full bg-blue-600 text-white py-3 rounded-lg font-bold hover:bg-blue-700 shadow-md text-lg">دخول</button>
            </form>
            <p id="login-error" class="text-red-500 mt-4 text-sm font-bold hidden">رمز المرور غير صحيح</p>
        </div>
        <p class="text-gray-500 text-xs mt-4">V3.0 - FOC & Stock Support</p>
    </div>

    <!-- Header -->
    <header class="bg-white border-b border-gray-200 px-6 py-4 flex items-center justify-between sticky top-0 z-20 shadow-sm no-print">
        <div class="flex items-center gap-3">
            <div class="bg-blue-600 p-2 rounded-lg">
                <i data-lucide="package" class="text-white w-6 h-6"></i>
            </div>
            <div>
                <h1 class="text-xl font-bold text-gray-800">نظام فوترة الموردين</h1>
                <div class="flex items-center gap-2">
                    <span class="text-xs px-2 py-0.5 bg-gray-100 rounded-full text-gray-600 font-bold" id="current-user-display"></span>
                </div>
            </div>
        </div>
        <div class="flex items-center gap-4">
            <div class="hidden sm:block text-left border-r border-gray-200 pr-4 mr-4">
                <p class="text-xs text-gray-500">إجمالي المستحق</p>
                <p class="text-lg font-bold text-red-600" id="header-total-due">0.000 ر.ع</p>
            </div>
            <button onclick="logout()" class="p-2 text-red-500 hover:bg-red-50 rounded-lg" title="خروج"><i data-lucide="log-out" class="w-5 h-5"></i></button>
            <button onclick="toggleMobileMenu()" class="md:hidden p-2 text-gray-600"><i data-lucide="menu" class="w-6 h-6"></i></button>
        </div>
    </header>

    <div class="flex flex-col md:flex-row min-h-[calc(100vh-80px)]">
        
        <!-- Sidebar -->
        <aside id="sidebar" class="w-full md:w-64 bg-white border-l border-gray-200 p-4 space-y-2 hidden md:block no-print transition-all">
            <button onclick="switchTab('dashboard')" class="nav-btn w-full flex items-center gap-3 px-4 py-3 rounded-lg text-blue-700 bg-blue-50 font-bold" data-tab="dashboard"><i data-lucide="layout-dashboard"></i><span>لوحة التحكم</span></button>
            <button onclick="switchTab('invoices')" class="nav-btn w-full flex items-center gap-3 px-4 py-3 rounded-lg text-gray-600 hover:bg-gray-50" data-tab="invoices"><i data-lucide="file-plus"></i><span>فاتورة جديدة</span></button>
            <button onclick="switchTab('suppliers')" class="nav-btn w-full flex items-center gap-3 px-4 py-3 rounded-lg text-gray-600 hover:bg-gray-50" data-tab="suppliers"><i data-lucide="users"></i><span>الموردين</span></button>
            <button onclick="switchTab('reports')" class="nav-btn w-full flex items-center gap-3 px-4 py-3 rounded-lg text-gray-600 hover:bg-gray-50" data-tab="reports"><i data-lucide="printer"></i><span>التقارير</span></button>
            <div id="admin-menu-items" class="hidden">
                <div class="border-t my-2 border-gray-100"></div>
                <button onclick="switchTab('users')" class="nav-btn w-full flex items-center gap-3 px-4 py-3 rounded-lg text-gray-600 hover:bg-gray-50" data-tab="users"><i data-lucide="user-cog"></i><span>المستخدمين</span></button>
                <button onclick="switchTab('settings')" class="nav-btn w-full flex items-center gap-3 px-4 py-3 rounded-lg text-gray-600 hover:bg-gray-50" data-tab="settings"><i data-lucide="settings"></i><span>الإعدادات</span></button>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="flex-1 p-4 md:p-8 overflow-y-auto w-full">
            
            <!-- VIEW: DASHBOARD -->
            <div id="view-dashboard" class="view-section space-y-6">
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    <div class="bg-white p-6 rounded-xl border-r-4 border-r-blue-500 shadow-sm"><p class="text-gray-500">المشتريات</p><h3 class="text-3xl font-bold" id="dash-total">0.000</h3></div>
                    <div class="bg-white p-6 rounded-xl border-r-4 border-r-green-500 shadow-sm"><p class="text-gray-500">المدفوعات</p><h3 class="text-3xl font-bold text-green-600" id="dash-paid">0.000</h3></div>
                    <div class="bg-white p-6 rounded-xl border-r-4 border-r-red-500 shadow-sm"><p class="text-gray-500">المستحق</p><h3 class="text-3xl font-bold text-red-600" id="dash-due">0.000</h3></div>
                </div>
                
                <h3 class="font-bold text-lg mt-8 mb-4">آخر الفواتير المسجلة</h3>
                <div class="bg-white rounded-xl shadow-sm border overflow-hidden">
                    <table class="w-full text-right">
                        <thead class="bg-gray-50 text-xs text-gray-600">
                            <tr><th class="p-3">رقم الفاتورة</th><th class="p-3">المورد</th><th class="p-3">التاريخ</th><th class="p-3">الاستحقاق</th><th class="p-3">الإجمالي</th><th class="p-3">الحالة</th></tr>
                        </thead>
                        <tbody id="dash-table-body" class="divide-y divide-gray-100 text-sm"></tbody>
                    </table>
                </div>
            </div>

            <!-- VIEW: ADD INVOICE (Master-Detail) -->
            <div id="view-invoices" class="view-section hidden space-y-6">
                <div class="flex items-center justify-between">
                    <h2 class="text-2xl font-bold text-gray-800 flex items-center gap-2"><i data-lucide="file-plus" class="text-blue-600"></i>فاتورة شراء جديدة</h2>
                    <button onclick="clearInvoiceForm()" class="text-sm text-red-500 hover:text-red-700">مسح النموذج</button>
                </div>

                <!-- 1. Invoice Header (Master) -->
                <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-200">
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                        <div class="md:col-span-1">
                            <label class="block text-xs font-bold text-gray-500 mb-1">المورد</label>
                            <select id="inv-supplier" class="w-full p-2 border rounded focus:ring-2 focus:ring-blue-500 bg-gray-50">
                                <option value="">اختر المورد...</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-xs font-bold text-gray-500 mb-1">رقم الفاتورة (للمورد)</label>
                            <input type="text" id="inv-number" class="w-full p-2 border rounded focus:ring-2 focus:ring-blue-500" placeholder="مثال: 2520125">
                        </div>
                        <div>
                            <label class="block text-xs font-bold text-gray-500 mb-1">تاريخ الفاتورة</label>
                            <input type="date" id="inv-date" class="w-full p-2 border rounded focus:ring-2 focus:ring-blue-500">
                        </div>
                        <div>
                            <label class="block text-xs font-bold text-gray-500 mb-1">تاريخ الاستحقاق</label>
                            <input type="date" id="inv-due-date" class="w-full p-2 border border-blue-300 bg-blue-50 rounded focus:ring-2 focus:ring-blue-500">
                        </div>
                    </div>
                </div>

                <!-- 2. Add Items (Detail Input) -->
                <div class="bg-gray-50 p-6 rounded-xl border border-gray-200 relative">
                    <h3 class="text-sm font-bold text-gray-700 mb-4 flex items-center gap-2"><i data-lucide="shopping-cart" class="w-4 h-4"></i>إضافة الأصناف للفاتورة</h3>
                    <div class="grid grid-cols-1 md:grid-cols-12 gap-3 items-end">
                        <div class="md:col-span-3">
                            <label class="text-xs block mb-1">اسم الصنف / البيان</label>
                            <input type="text" id="item-name" placeholder="اسم المنتج" class="w-full p-2 border rounded text-sm">
                        </div>
                        <div class="md:col-span-1">
                            <label class="text-xs block mb-1">UOM</label>
                            <input type="text" id="item-uom" placeholder="PAK30" class="w-full p-2 border rounded text-sm">
                        </div>
                        <div class="md:col-span-2">
                            <label class="text-xs block mb-1">تاريخ الانتهاء</label>
                            <input type="date" id="item-expiry" class="w-full p-2 border rounded text-sm">
                        </div>
                        <div class="md:col-span-1">
                            <label class="text-xs block mb-1 text-blue-600">الرصيد الحالي</label>
                            <input type="number" id="item-stock" placeholder="0" class="w-full p-2 border border-blue-200 bg-blue-50 rounded text-sm">
                        </div>
                        <div class="md:col-span-1">
                            <label class="text-xs block mb-1">الكمية</label>
                            <input type="number" id="item-qty" value="1" min="1" class="w-full p-2 border rounded text-sm font-bold" oninput="calcItemTotal()">
                        </div>
                        <div class="md:col-span-1">
                            <label class="text-xs block mb-1">السعر (ر.ع)</label>
                            <input type="number" id="item-price" value="0" step="0.001" min="0" class="w-full p-2 border rounded text-sm" oninput="calcItemTotal()">
                        </div>
                        <div class="md:col-span-1 flex items-center gap-2 pb-2">
                            <input type="checkbox" id="item-foc" class="w-4 h-4 text-blue-600" onchange="toggleFOC()">
                            <label for="item-foc" class="text-xs font-bold cursor-pointer select-none">FOC<br><span class="text-[10px] text-gray-500">مجاني</span></label>
                        </div>
                        <div class="md:col-span-2">
                            <button onclick="addInvoiceItem()" class="w-full bg-blue-600 hover:bg-blue-700 text-white py-2 rounded text-sm font-bold flex items-center justify-center gap-1">
                                <i data-lucide="plus"></i> إضافة
                            </button>
                        </div>
                    </div>
                    <div class="mt-2 text-left text-xs text-gray-500">
                        الإجمالي للصنف: <span id="item-line-total" class="font-bold text-blue-600">0.000</span> ر.ع
                    </div>
                </div>

                <!-- 3. Items List Table -->
                <div class="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden">
                    <table class="w-full text-right text-sm">
                        <thead class="bg-gray-100 text-gray-600 border-b">
                            <tr>
                                <th class="p-3">#</th>
                                <th class="p-3">الصنف</th>
                                <th class="p-3">UOM</th>
                                <th class="p-3">الانتهاء</th>
                                <th class="p-3 text-center">رصيد سابق</th>
                                <th class="p-3 text-center">الكمية</th>
                                <th class="p-3">السعر</th>
                                <th class="p-3">الإجمالي</th>
                                <th class="p-3 text-center">حذف</th>
                            </tr>
                        </thead>
                        <tbody id="invoice-items-body" class="divide-y divide-gray-50">
                            <tr><td colspan="9" class="p-4 text-center text-gray-400">لا توجد أصناف مضافة بعد</td></tr>
                        </tbody>
                        <tfoot class="bg-blue-50 font-bold border-t border-blue-100">
                            <tr>
                                <td colspan="7" class="p-3 text-left pl-4">إجمالي الفاتورة:</td>
                                <td colspan="2" class="p-3 text-blue-700 text-lg"><span id="invoice-grand-total">0.000</span> ر.ع</td>
                            </tr>
                        </tfoot>
                    </table>
                </div>

                <!-- 4. Save Actions -->
                <div class="flex gap-4 items-center bg-white p-4 rounded-xl border border-gray-200">
                    <div class="flex-1">
                        <label class="flex items-center gap-2 cursor-pointer">
                            <input type="checkbox" id="inv-paid-status" class="w-5 h-5 text-green-600">
                            <span class="font-medium">دفع فوري (كاش)</span>
                        </label>
                    </div>
                    <button onclick="saveFullInvoice()" class="flex-1 bg-green-600 hover:bg-green-700 text-white py-3 rounded-lg font-bold shadow-sm flex justify-center items-center gap-2">
                        <i data-lucide="save"></i> حفظ الفاتورة كاملة
                    </button>
                </div>
            </div>

            <!-- VIEW: SUPPLIERS -->
            <div id="view-suppliers" class="view-section hidden space-y-6">
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    <div class="bg-white p-6 rounded-xl border h-fit md:col-span-1">
                        <h3 class="font-bold text-lg mb-4 flex items-center gap-2"><i data-lucide="user-plus" class="text-blue-600"></i>مورد جديد</h3>
                        <form id="supplier-form" class="space-y-3">
                            <input type="text" id="sup-name" placeholder="اسم الشركة / المورد" required class="w-full p-2 border rounded text-sm">
                            <input type="text" id="sup-phone" placeholder="رقم الهاتف" class="w-full p-2 border rounded text-sm">
                            <input type="email" id="sup-email" placeholder="البريد الإلكتروني" class="w-full p-2 border rounded text-sm">
                            <input type="text" id="sup-bank" placeholder="رقم الحساب البنكي" class="w-full p-2 border rounded text-sm">
                            <button type="submit" class="w-full bg-blue-600 text-white py-2 rounded font-bold hover:bg-blue-700">حفظ</button>
                        </form>
                    </div>
                    <div id="suppliers-list" class="md:col-span-2 space-y-3"></div>
                </div>
            </div>

            <!-- VIEW: REPORTS -->
            <div id="view-reports" class="view-section hidden space-y-6">
                <div class="flex justify-between items-center no-print">
                    <h2 class="text-2xl font-bold flex gap-2"><i data-lucide="file-text" class="text-blue-600"></i>تقارير الفواتير</h2>
                    <div class="flex gap-2">
                        <select id="report-filter" class="p-2 border rounded bg-white" onchange="renderReports()"><option value="all">الكل</option></select>
                        <button onclick="window.print()" class="px-4 py-2 border rounded hover:bg-gray-50 flex gap-2"><i data-lucide="printer"></i>طباعة</button>
                    </div>
                </div>
                <div id="reports-container" class="space-y-8"></div>
            </div>

            <!-- Other Views (Users, Settings) remain similar but hidden for brevity in this specific update -->
            <div id="view-users" class="view-section hidden space-y-6">
                <!-- Simple User Management UI -->
                <div class="bg-white p-6 rounded shadow border">
                    <h3 class="font-bold mb-4">إضافة مستخدم (رمز المرور فقط)</h3>
                    <div class="flex gap-2 mb-6">
                        <input id="new-user-name" placeholder="الاسم" class="border p-2 rounded">
                        <input id="new-user-pass" placeholder="الرمز" class="border p-2 rounded">
                        <select id="new-user-role" class="border p-2 rounded"><option value="user">مستخدم</option><option value="admin">مدير</option></select>
                        <button onclick="addUser()" class="bg-blue-600 text-white px-4 rounded">إضافة</button>
                    </div>
                    <div id="users-list" class="space-y-2"></div>
                </div>
            </div>
            
            <div id="view-settings" class="view-section hidden bg-white p-6 rounded shadow">
                <h3 class="font-bold mb-4">قاعدة البيانات</h3>
                <div class="flex gap-4">
                    <button onclick="exportData()" class="bg-green-600 text-white px-4 py-2 rounded flex gap-2"><i data-lucide="download"></i>تصدير</button>
                    <label class="bg-blue-600 text-white px-4 py-2 rounded flex gap-2 cursor-pointer"><i data-lucide="upload"></i>استيراد<input type="file" hidden onchange="importData(this)"></label>
                    <button onclick="resetData()" class="bg-red-600 text-white px-4 py-2 rounded flex gap-2"><i data-lucide="trash"></i>تصفير</button>
                </div>
            </div>

        </main>
    </div>

    <!-- Logic -->
    <script>
        // --- State Management ---
        const defaultUsers = [{ id: 1, password: '2040', role: 'admin', name: 'المدير العام', active: true }];
        let users = JSON.parse(localStorage.getItem('billing_users')) || defaultUsers;
        let suppliers = JSON.parse(localStorage.getItem('billing_suppliers')) || [];
        // New Data Structure: invoices array contains Invoice Objects, which contain an 'items' array
        let invoices = JSON.parse(localStorage.getItem('billing_invoices_v2')) || [];
        
        // ** Force Admin Password Update (Security Fix) **
        const adminUser = users.find(u => u.id === 1);
        if (adminUser) {
            adminUser.password = '2040'; // Enforce 2040
            adminUser.role = 'admin';
            adminUser.active = true;
            localStorage.setItem('billing_users', JSON.stringify(users));
        } else {
            // Re-create if missing
            users.unshift({ id: 1, password: '2040', role: 'admin', name: 'المدير العام', active: true });
            localStorage.setItem('billing_users', JSON.stringify(users));
        }

        let currentUser = null;
        let tempItems = []; // Temporary holding items for new invoice

        // --- Auth ---
        document.getElementById('login-form').addEventListener('submit', (e) => {
            e.preventDefault();
            const pass = document.getElementById('login-password').value.trim();
            const user = users.find(u => u.password === pass);
            if(user && user.active){
                currentUser = user;
                document.getElementById('login-screen').classList.add('hidden');
                document.getElementById('current-user-display').textContent = user.name;
                document.getElementById('admin-menu-items').classList.toggle('hidden', user.role !== 'admin');
                renderAll();
            } else {
                document.getElementById('login-error').classList.remove('hidden');
                document.getElementById('login-error').textContent = user ? 'الحساب معطل' : 'الرمز غير صحيح';
            }
        });

        function logout() { location.reload(); }

        // --- Invoice Logic (Master-Detail) ---
        
        function toggleFOC() {
            const isFoc = document.getElementById('item-foc').checked;
            const priceInput = document.getElementById('item-price');
            if(isFoc) {
                priceInput.value = 0;
                priceInput.disabled = true;
            } else {
                priceInput.disabled = false;
            }
            calcItemTotal();
        }

        function calcItemTotal() {
            const qty = parseFloat(document.getElementById('item-qty').value) || 0;
            const price = parseFloat(document.getElementById('item-price').value) || 0;
            document.getElementById('item-line-total').textContent = (qty * price).toFixed(3);
        }

        function addInvoiceItem() {
            const name = document.getElementById('item-name').value;
            if(!name) return alert("أدخل اسم الصنف");

            const item = {
                id: Date.now(),
                name: name,
                uom: document.getElementById('item-uom').value || '-',
                expiry: document.getElementById('item-expiry').value || '-',
                stock: document.getElementById('item-stock').value || 0, // Recorded for reference
                qty: parseFloat(document.getElementById('item-qty').value) || 0,
                price: parseFloat(document.getElementById('item-price').value) || 0,
                isFoc: document.getElementById('item-foc').checked
            };
            item.total = item.qty * item.price;

            tempItems.push(item);
            renderTempItems();
            
            // Clear Item Inputs
            document.getElementById('item-name').value = '';
            document.getElementById('item-uom').value = '';
            document.getElementById('item-expiry').value = '';
            document.getElementById('item-stock').value = '';
            document.getElementById('item-qty').value = 1;
            document.getElementById('item-price').value = 0;
            document.getElementById('item-foc').checked = false;
            document.getElementById('item-price').disabled = false;
            document.getElementById('item-name').focus();
        }

        function removeTempItem(id) {
            tempItems = tempItems.filter(i => i.id !== id);
            renderTempItems();
        }

        function renderTempItems() {
            const tbody = document.getElementById('invoice-items-body');
            tbody.innerHTML = '';
            let grandTotal = 0;

            tempItems.forEach((item, index) => {
                grandTotal += item.total;
                const focBadge = item.isFoc ? '<span class="bg-purple-100 text-purple-700 text-xs px-2 rounded">FOC</span>' : '';
                
                tbody.innerHTML += `
                    <tr class="border-b">
                        <td class="p-3">${index + 1}</td>
                        <td class="p-3 font-bold">${item.name} ${focBadge}</td>
                        <td class="p-3 text-gray-500">${item.uom}</td>
                        <td class="p-3 text-gray-500">${item.expiry}</td>
                        <td class="p-3 text-center text-blue-600">${item.stock}</td>
                        <td class="p-3 text-center font-bold">${item.qty}</td>
                        <td class="p-3">${item.price.toFixed(3)}</td>
                        <td class="p-3 font-bold">${item.total.toFixed(3)}</td>
                        <td class="p-3 text-center">
                            <button onclick="removeTempItem(${item.id})" class="text-red-500 hover:bg-red-50 p-1 rounded"><i data-lucide="trash-2" class="w-4 h-4"></i></button>
                        </td>
                    </tr>
                `;
            });

            if(tempItems.length === 0) tbody.innerHTML = '<tr><td colspan="9" class="p-6 text-center text-gray-400">ابدأ بإضافة الأصناف من النموذج أعلاه</td></tr>';
            
            document.getElementById('invoice-grand-total').textContent = grandTotal.toFixed(3);
        }

        function saveFullInvoice() {
            const supplierId = document.getElementById('inv-supplier').value;
            const invNumber = document.getElementById('inv-number').value;
            const date = document.getElementById('inv-date').value;
            
            if(!supplierId || !invNumber || !date) return alert("الرجاء إكمال بيانات ترويسة الفاتورة (المورد، الرقم، التاريخ)");
            if(tempItems.length === 0) return alert("لا يمكن حفظ فاتورة فارغة! أضف أصنافاً أولاً.");

            const totalAmount = tempItems.reduce((sum, i) => sum + i.total, 0);
            
            const newInvoice = {
                id: Date.now(),
                invoiceNumber: invNumber,
                supplierId: parseInt(supplierId),
                date: date,
                dueDate: document.getElementById('inv-due-date').value || date,
                items: [...tempItems], // Copy items
                totalAmount: totalAmount,
                status: document.getElementById('inv-paid-status').checked ? 'paid' : 'unpaid',
                createdBy: currentUser.name
            };

            invoices.push(newInvoice);
            localStorage.setItem('billing_invoices_v2', JSON.stringify(invoices));
            
            alert("تم حفظ الفاتورة بنجاح!");
            clearInvoiceForm();
            switchTab('dashboard'); // Go to dashboard to see it
        }

        function clearInvoiceForm() {
            tempItems = [];
            renderTempItems();
            document.getElementById('inv-number').value = '';
            document.getElementById('inv-paid-status').checked = false;
        }

        // --- Suppliers Logic ---
        document.getElementById('supplier-form').addEventListener('submit', (e) => {
            e.preventDefault();
            const s = {
                id: Date.now(),
                name: document.getElementById('sup-name').value,
                phone: document.getElementById('sup-phone').value,
                email: document.getElementById('sup-email').value,
                bank: document.getElementById('sup-bank').value
            };
            suppliers.push(s);
            localStorage.setItem('billing_suppliers', JSON.stringify(suppliers));
            e.target.reset();
            renderSuppliers();
            populateSupplierSelect();
        });

        function renderSuppliers() {
            const container = document.getElementById('suppliers-list');
            container.innerHTML = '';
            suppliers.forEach(s => {
                // Calculate due for this supplier
                const suppInvoices = invoices.filter(i => i.supplierId === s.id);
                const due = suppInvoices.filter(i => i.status === 'unpaid').reduce((sum, i) => sum + i.totalAmount, 0);
                
                container.innerHTML += `
                    <div class="bg-white p-4 rounded-xl border flex justify-between items-center shadow-sm">
                        <div>
                            <h4 class="font-bold text-gray-800">${s.name}</h4>
                            <p class="text-xs text-gray-500">${s.phone || '-'} | ${s.email || '-'}</p>
                            <p class="text-xs text-gray-400 mt-1">Bank: ${s.bank || 'غير مسجل'}</p>
                        </div>
                        <div class="text-left">
                            <p class="text-xs text-gray-500">المستحق</p>
                            <p class="font-bold ${due > 0 ? 'text-red-600' : 'text-green-600'}">${due.toFixed(3)} ر.ع</p>
                            <button onclick="deleteSupplier(${s.id})" class="text-red-400 text-xs mt-2 hover:underline">حذف</button>
                        </div>
                    </div>
                `;
            });
        }

        function populateSupplierSelect() {
            const sel = document.getElementById('inv-supplier');
            const repSel = document.getElementById('report-filter');
            
            // Keep first option
            sel.innerHTML = '<option value="">اختر المورد...</option>';
            repSel.innerHTML = '<option value="all">الكل</option>';

            suppliers.forEach(s => {
                sel.innerHTML += `<option value="${s.id}">${s.name}</option>`;
                repSel.innerHTML += `<option value="${s.id}">${s.name}</option>`;
            });
        }

        // --- Dashboard & Reports ---
        function renderDashboard() {
            const total = invoices.reduce((sum, i) => sum + i.totalAmount, 0);
            const paid = invoices.filter(i => i.status === 'paid').reduce((sum, i) => sum + i.totalAmount, 0);
            const due = total - paid;

            document.getElementById('dash-total').textContent = total.toFixed(3);
            document.getElementById('dash-paid').textContent = paid.toFixed(3);
            document.getElementById('dash-due').textContent = due.toFixed(3);
            document.getElementById('header-total-due').textContent = due.toFixed(3) + ' ر.ع';

            const tbody = document.getElementById('dash-table-body');
            tbody.innerHTML = '';
            // Show last 5 invoices
            invoices.slice().reverse().slice(0, 5).forEach(inv => {
                const sup = suppliers.find(s => s.id === inv.supplierId)?.name || 'مجهول';
                const statusHtml = inv.status === 'paid' 
                    ? '<span class="text-green-600 bg-green-50 px-2 py-1 rounded text-xs font-bold">مدفوع</span>' 
                    : '<span class="text-red-600 bg-red-50 px-2 py-1 rounded text-xs font-bold">مستحق</span>';
                
                tbody.innerHTML += `
                    <tr class="border-b">
                        <td class="p-3">${inv.invoiceNumber}</td>
                        <td class="p-3">${sup}</td>
                        <td class="p-3">${inv.date}</td>
                        <td class="p-3">${inv.dueDate}</td>
                        <td class="p-3 font-bold">${inv.totalAmount.toFixed(3)}</td>
                        <td class="p-3">${statusHtml}</td>
                    </tr>
                `;
            });
        }

        function renderReports() {
            const container = document.getElementById('reports-container');
            container.innerHTML = '';
            const filterId = document.getElementById('report-filter').value;
            
            let filteredInvoices = invoices;
            if(filterId !== 'all') {
                filteredInvoices = invoices.filter(i => i.supplierId == filterId);
            }

            if(filteredInvoices.length === 0) {
                container.innerHTML = '<p class="text-center text-gray-400">لا توجد بيانات</p>';
                return;
            }

            filteredInvoices.slice().reverse().forEach(inv => {
                const sup = suppliers.find(s => s.id === inv.supplierId)?.name || 'مورد محذوف';
                const statusColor = inv.status === 'paid' ? 'green' : 'red';
                const statusText = inv.status === 'paid' ? 'مدفوع' : 'مستحق للدفع';
                
                // Calculate days remaining
                const today = new Date();
                const due = new Date(inv.dueDate);
                const diffTime = due - today;
                const daysDiff = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                let daysText = '';
                if(inv.status !== 'paid') {
                    if(daysDiff < 0) daysText = `<span class="text-red-600 font-bold ml-2">(متأخر ${Math.abs(daysDiff)} يوم)</span>`;
                    else daysText = `<span class="text-blue-600 ml-2">(باقي ${daysDiff} يوم)</span>`;
                }

                // Build Items Table for this invoice
                let itemsRows = '';
                inv.items.forEach(item => {
                    const foc = item.isFoc ? '<span class="bg-purple-100 text-purple-800 text-[10px] px-1 rounded">مجاني</span>' : '';
                    itemsRows += `
                        <tr class="border-b text-xs text-gray-600">
                            <td class="p-2">${item.name} ${foc}</td>
                            <td class="p-2 text-center">${item.uom}</td>
                            <td class="p-2 text-center">${item.expiry}</td>
                            <td class="p-2 text-center">${item.qty}</td>
                            <td class="p-2 text-center">${item.price.toFixed(3)}</td>
                            <td class="p-2 text-center font-bold">${item.total.toFixed(3)}</td>
                        </tr>
                    `;
                });

                const card = `
                    <div class="bg-white border rounded-xl overflow-hidden print-break-inside">
                        <div class="bg-gray-50 p-4 border-b flex justify-between items-start">
                            <div>
                                <h3 class="font-bold text-lg text-gray-800">فاتورة رقم: ${inv.invoiceNumber}</h3>
                                <p class="text-sm text-gray-500">المورد: <span class="font-bold text-gray-700">${sup}</span></p>
                                <p class="text-xs text-gray-400 mt-1">تاريخ: ${inv.date} | استحقاق: ${inv.dueDate} ${daysText}</p>
                            </div>
                            <div class="text-left">
                                <span class="block text-2xl font-bold text-gray-800">${inv.totalAmount.toFixed(3)} ر.ع</span>
                                <span class="inline-block mt-1 px-2 py-1 rounded text-xs font-bold text-${statusColor}-700 bg-${statusColor}-100 border border-${statusColor}-200 cursor-pointer" onclick="toggleStatus(${inv.id})">${statusText}</span>
                            </div>
                        </div>
                        <div class="p-4">
                            <table class="w-full text-right">
                                <thead class="bg-gray-50 text-xs text-gray-500">
                                    <tr><th class="p-2">الصنف</th><th class="p-2 text-center">UOM</th><th class="p-2 text-center">Exp</th><th class="p-2 text-center">الكمية</th><th class="p-2 text-center">السعر</th><th class="p-2 text-center">الإجمالي</th></tr>
                                </thead>
                                <tbody>${itemsRows}</tbody>
                            </table>
                        </div>
                    </div>
                `;
                container.innerHTML += card;
            });
        }

        function toggleStatus(id) {
            const inv = invoices.find(i => i.id === id);
            if(inv) {
                inv.status = inv.status === 'paid' ? 'unpaid' : 'paid';
                localStorage.setItem('billing_invoices_v2', JSON.stringify(invoices));
                renderAll();
            }
        }

        // --- User Management ---
        function renderUsers() {
            const container = document.getElementById('users-list');
            container.innerHTML = '';
            users.forEach(u => {
                const statusColor = u.active ? 'green' : 'red';
                const toggleIcon = u.active ? 'unlock' : 'lock';
                
                // Prevent editing main admin (id 1)
                const isProtected = u.id === 1;
                const actions = isProtected ? '<span class="text-xs text-gray-400">محمي</span>' : `
                    <button onclick="toggleUser(${u.id})" class="text-${statusColor}-600 p-1"><i data-lucide="${toggleIcon}" class="w-4 h-4"></i></button>
                    <button onclick="deleteUser(${u.id})" class="text-red-500 p-1"><i data-lucide="trash-2" class="w-4 h-4"></i></button>
                `;

                container.innerHTML += `
                    <div class="flex justify-between items-center bg-gray-50 p-2 rounded border">
                        <div>
                            <span class="font-bold text-sm block">${u.name}</span>
                            <span class="text-xs text-gray-500">الرمز: ${u.password} | ${u.role === 'admin' ? 'مدير' : 'مستخدم'}</span>
                        </div>
                        <div class="flex gap-2">${actions}</div>
                    </div>
                `;
            });
        }

        function addUser() {
            const name = document.getElementById('new-user-name').value;
            const pass = document.getElementById('new-user-pass').value;
            const role = document.getElementById('new-user-role').value;
            
            if(!name || !pass) return alert("أكمل البيانات");
            if(users.some(u => u.password === pass)) return alert("الرمز مستخدم");

            users.push({ id: Date.now(), name, password: pass, role, active: true });
            localStorage.setItem('billing_users', JSON.stringify(users));
            renderUsers();
            document.getElementById('new-user-name').value = '';
            document.getElementById('new-user-pass').value = '';
        }

        function toggleUser(id) {
            const u = users.find(x => x.id === id);
            if(u) { u.active = !u.active; localStorage.setItem('billing_users', JSON.stringify(users)); renderUsers(); }
        }
        
        function deleteUser(id) {
            if(confirm("حذف المستخدم؟")) {
                users = users.filter(x => x.id !== id);
                localStorage.setItem('billing_users', JSON.stringify(users));
                renderUsers();
            }
        }

        // --- Common ---
        function switchTab(tab) {
            document.querySelectorAll('.view-section').forEach(el => el.classList.add('hidden'));
            document.getElementById('view-' + tab).classList.remove('hidden');
            renderAll();
        }

        function renderAll() {
            if(!currentUser) return;
            renderDashboard();
            renderSuppliers();
            populateSupplierSelect();
            renderReports();
            if(currentUser.role === 'admin') renderUsers();
            lucide.createIcons();
        }

        // --- Settings ---
        function resetData() {
            if(confirm("تحذير: سيتم حذف جميع الفواتير والموردين!")) {
                localStorage.removeItem('billing_invoices_v2');
                localStorage.removeItem('billing_suppliers');
                location.reload();
            }
        }
        
        // Setup Date
        document.getElementById('inv-date').valueAsDate = new Date();
        document.getElementById('inv-due-date').valueAsDate = new Date(new Date().setDate(new Date().getDate() + 30));

        // Initial Logic
        lucide.createIcons();
    </script>
</body>
</html>