<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>نظام فوترة الموردين</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+Arabic:wght@300;400;600;700&display=swap" rel="stylesheet">

    <style>
        body { font-family: 'Noto Sans Arabic', sans-serif; }
        @media print {
            .no-print { display: none !important; }
            .print-only { display: block !important; }
            body, main { background: white; height: auto; overflow: visible; }
            .card { box-shadow: none; border: none; }
            table { width: 100%; border: 1px solid #ddd; }
            th, td { border: 1px solid #ddd; padding: 8px; }
        }
    </style>
</head>
<body class="bg-gray-50 text-gray-800">

    <!-- Header -->
    <header class="bg-white border-b border-gray-200 px-6 py-4 flex items-center justify-between sticky top-0 z-20 shadow-sm no-print">
        <div class="flex items-center gap-3">
            <div class="bg-blue-600 p-2 rounded-lg">
                <i data-lucide="package" class="text-white w-6 h-6"></i>
            </div>
            <div>
                <h1 class="text-xl font-bold text-gray-800">نظام فوترة الموردين</h1>
                <p class="text-xs text-gray-500" id="header-subtitle">إدارة المدفوعات والسلع</p>
            </div>
        </div>
        <div class="flex items-center gap-4">
            <div class="flex items-center gap-1 text-xs text-green-600 bg-green-50 px-2 py-1 rounded-full">
                <i data-lucide="save" class="w-3 h-3"></i>
                <span>حفظ تلقائي مفعل</span>
            </div>
            <div class="text-left hidden sm:block border-r border-gray-200 pr-4 mr-4">
                <p class="text-sm text-gray-500">إجمالي المستحق للدفع</p>
                <p class="text-lg font-bold text-red-600" id="header-total-due">0.000 ر.ع</p>
            </div>
            <!-- Mobile Menu Button -->
            <button onclick="toggleMobileMenu()" class="md:hidden p-2 text-gray-600">
                <i data-lucide="menu" class="w-6 h-6"></i>
            </button>
        </div>
    </header>

    <div class="flex flex-col md:flex-row min-h-[calc(100vh-80px)]">
        
        <!-- Sidebar -->
        <aside id="sidebar" class="w-full md:w-64 bg-white border-l border-gray-200 p-4 space-y-2 hidden md:block no-print transition-all">
            <button onclick="switchTab('dashboard')" class="nav-btn w-full flex items-center gap-3 px-4 py-3 rounded-lg transition-colors text-blue-700 bg-blue-50 font-bold" data-tab="dashboard">
                <i data-lucide="layout-dashboard" class="w-5 h-5"></i>
                <span>لوحة التحكم</span>
            </button>
            <button onclick="switchTab('invoices')" class="nav-btn w-full flex items-center gap-3 px-4 py-3 rounded-lg transition-colors text-gray-600 hover:bg-gray-50" data-tab="invoices">
                <i data-lucide="file-plus" class="w-5 h-5"></i>
                <span>تسجيل فاتورة</span>
            </button>
            <button onclick="switchTab('suppliers')" class="nav-btn w-full flex items-center gap-3 px-4 py-3 rounded-lg transition-colors text-gray-600 hover:bg-gray-50" data-tab="suppliers">
                <i data-lucide="users" class="w-5 h-5"></i>
                <span>إدارة الموردين</span>
            </button>
            <button onclick="switchTab('reports')" class="nav-btn w-full flex items-center gap-3 px-4 py-3 rounded-lg transition-colors text-gray-600 hover:bg-gray-50" data-tab="reports">
                <i data-lucide="printer" class="w-5 h-5"></i>
                <span>التقارير الشاملة</span>
            </button>
            <div class="border-t my-2 border-gray-100"></div>
            <button onclick="switchTab('settings')" class="nav-btn w-full flex items-center gap-3 px-4 py-3 rounded-lg transition-colors text-gray-600 hover:bg-gray-50" data-tab="settings">
                <i data-lucide="settings" class="w-5 h-5"></i>
                <span>إدارة البيانات</span>
            </button>
        </aside>

        <!-- Main Content -->
        <main class="flex-1 p-4 md:p-8 overflow-y-auto w-full">
            
            <!-- VIEW: DASHBOARD -->
            <div id="view-dashboard" class="view-section space-y-6">
                <h2 class="text-2xl font-bold text-gray-800 mb-6">نظرة عامة</h2>
                
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-100 border-r-4 border-r-blue-500">
                        <p class="text-gray-500 mb-1">إجمالي المشتريات</p>
                        <h3 class="text-3xl font-bold text-gray-800"><span id="dash-total">0.000</span> <span class="text-sm font-normal">ر.ع</span></h3>
                    </div>
                    <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-100 border-r-4 border-r-green-500">
                        <p class="text-gray-500 mb-1">المدفوعات المكتملة</p>
                        <h3 class="text-3xl font-bold text-green-600"><span id="dash-paid">0.000</span> <span class="text-sm font-normal">ر.ع</span></h3>
                    </div>
                    <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-100 border-r-4 border-r-red-500">
                        <p class="text-gray-500 mb-1">المستحق للدفع</p>
                        <h3 class="text-3xl font-bold text-red-600"><span id="dash-due">0.000</span> <span class="text-sm font-normal">ر.ع</span></h3>
                    </div>
                </div>

                <div class="mt-8">
                    <h3 class="text-lg font-bold mb-4 flex items-center gap-2">
                        <i data-lucide="calendar" class="text-gray-500 w-5 h-5"></i>
                        آخر المعاملات والاستحقاقات
                    </h3>
                    <div class="overflow-x-auto bg-white rounded-xl shadow-sm border border-gray-200">
                        <table class="w-full text-right">
                            <thead class="bg-gray-50 text-gray-600 text-sm">
                                <tr>
                                    <th class="p-4">التاريخ</th>
                                    <th class="p-4">المورد</th>
                                    <th class="p-4">السلعة</th>
                                    <th class="p-4">الإجمالي</th>
                                    <th class="p-4">تاريخ الاستحقاق</th>
                                    <th class="p-4">الحالة / المتبقي</th>
                                </tr>
                            </thead>
                            <tbody id="dash-table-body" class="divide-y divide-gray-100">
                                <!-- Populated by JS -->
                            </tbody>
                        </table>
                        <p id="dash-empty-msg" class="p-8 text-center text-gray-400 hidden">لا توجد معاملات مسجلة</p>
                    </div>
                </div>
            </div>

            <!-- VIEW: ADD INVOICE -->
            <div id="view-invoices" class="view-section hidden max-w-2xl mx-auto">
                <h2 class="text-2xl font-bold text-gray-800 mb-6 flex items-center gap-2">
                    <i data-lucide="file-plus" class="text-blue-600 w-6 h-6"></i>
                    تسجيل فاتورة جديدة
                </h2>
                
                <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-6 md:p-8">
                    <form id="invoice-form" class="space-y-6">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">اختر المورد</label>
                            <select id="inv-supplier" required class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:outline-none bg-white">
                                <option value="">-- اختر من القائمة --</option>
                                <!-- Populated by JS -->
                            </select>
                            <p id="no-suppliers-msg" class="text-red-500 text-xs mt-1 hidden">يجب إضافة موردين أولاً من قائمة "إدارة الموردين"</p>
                        </div>

                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div class="md:col-span-2">
                                <label class="block text-sm font-medium text-gray-700 mb-2">اسم السلعة / الخدمة</label>
                                <input type="text" id="inv-item" required placeholder="مثال: أسمنت، أجهزة كمبيوتر..." class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:outline-none">
                            </div>

                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">الكمية</label>
                                <input type="number" id="inv-qty" min="1" value="1" required class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:outline-none" oninput="calculateTotal()">
                            </div>

                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">سعر الوحدة (ر.ع)</label>
                                <input type="number" id="inv-price" min="0" step="0.001" value="0" required class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:outline-none" oninput="calculateTotal()">
                            </div>
                        </div>

                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">تاريخ الفاتورة</label>
                                <input type="date" id="inv-date" required class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:outline-none">
                            </div>

                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">تاريخ الاستحقاق (موعد الدفع)</label>
                                <input type="date" id="inv-due-date" required class="w-full p-3 border border-blue-300 bg-blue-50 rounded-lg focus:ring-2 focus:ring-blue-500 focus:outline-none">
                                <p class="text-xs text-gray-500 mt-1">افتراضياً 30 يوماً من اليوم</p>
                            </div>
                        </div>

                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">حالة الدفع</label>
                            <div class="flex gap-4 p-3 bg-gray-50 rounded-lg border border-gray-200">
                                <label class="flex items-center gap-2 cursor-pointer">
                                    <input type="radio" name="inv-status" value="unpaid" checked>
                                    <span class="text-red-600 font-medium">غير مدفوع (آجل)</span>
                                </label>
                                <label class="flex items-center gap-2 cursor-pointer">
                                    <input type="radio" name="inv-status" value="paid">
                                    <span class="text-green-600 font-medium">مدفوع (كاش)</span>
                                </label>
                            </div>
                        </div>

                        <div class="bg-blue-50 p-4 rounded-lg flex justify-between items-center">
                            <span class="text-blue-800 font-medium">الإجمالي المحسوب:</span>
                            <span class="text-2xl font-bold text-blue-800">
                                <span id="inv-total-display">0.000</span> ر.ع
                            </span>
                        </div>

                        <button type="submit" class="w-full bg-blue-600 text-white hover:bg-blue-700 py-3 rounded-lg font-medium flex items-center justify-center gap-2 text-lg transition-colors">
                            <i data-lucide="plus" class="w-5 h-5"></i>
                            حفظ الفاتورة
                        </button>
                    </form>
                </div>
            </div>

            <!-- VIEW: SUPPLIERS -->
            <div id="view-suppliers" class="view-section hidden space-y-6">
                <div class="flex justify-between items-center">
                    <h2 class="text-2xl font-bold text-gray-800">قائمة الموردين</h2>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    <!-- Add Supplier Form -->
                    <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-6 h-fit md:col-span-1">
                        <h3 class="font-bold text-lg mb-4 flex items-center gap-2">
                            <i data-lucide="user-plus" class="text-blue-600 w-5 h-5"></i>
                            إضافة مورد جديد
                        </h3>
                        <form id="supplier-form" class="space-y-4">
                            <input type="text" id="sup-name" placeholder="اسم المورد / الشركة" required class="w-full p-2 border border-gray-300 rounded focus:ring-2 focus:ring-blue-500 outline-none">
                            <input type="text" id="sup-phone" placeholder="رقم الهاتف (اختياري)" class="w-full p-2 border border-gray-300 rounded focus:ring-2 focus:ring-blue-500 outline-none">
                            <button type="submit" class="w-full bg-blue-600 text-white hover:bg-blue-700 py-2 rounded-lg font-medium">إضافة</button>
                        </form>
                    </div>

                    <!-- Suppliers List -->
                    <div id="suppliers-list" class="md:col-span-2 space-y-3">
                        <!-- Populated by JS -->
                    </div>
                </div>
            </div>

            <!-- VIEW: REPORTS -->
            <div id="view-reports" class="view-section hidden space-y-6">
                <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-4 no-print">
                    <h2 class="text-2xl font-bold text-gray-800 flex items-center gap-2">
                        <i data-lucide="printer" class="text-blue-600 w-6 h-6"></i>
                        تقرير كشف حساب
                    </h2>
                    <div class="flex gap-2 w-full md:w-auto">
                        <select id="report-supplier-filter" class="p-2 border border-gray-300 rounded-lg bg-white flex-1 md:w-64" onchange="updateReport()">
                            <option value="all">جميع الموردين</option>
                            <!-- Populated by JS -->
                        </select>
                        <button onclick="window.print()" class="px-4 py-2 border border-gray-300 text-gray-700 hover:bg-gray-50 rounded-lg flex items-center gap-2">
                            <i data-lucide="printer" class="w-4 h-4"></i>
                            طباعة
                        </button>
                    </div>
                </div>

                <div class="bg-white p-8 rounded-xl shadow-sm border border-gray-200 print:shadow-none print:border-none print:p-0">
                    <div class="mb-8 border-b pb-4">
                        <div class="flex justify-between items-center mb-4">
                            <h1 class="text-3xl font-bold text-gray-900">تقرير المشتريات والمدفوعات</h1>
                            <div class="text-left text-sm text-gray-500">
                                <p>تاريخ التقرير: <span id="report-date"></span></p>
                            </div>
                        </div>
                        <div id="report-header-filter" class="hidden bg-blue-50 p-4 rounded-lg border border-blue-100">
                            <h3 class="text-blue-900 font-bold text-lg">المورد: <span id="report-supplier-name"></span></h3>
                        </div>
                    </div>

                    <div class="grid grid-cols-2 gap-8 mb-8">
                        <div class="bg-gray-50 p-4 rounded border">
                            <p class="text-sm text-gray-500">إجمالي المعاملات</p>
                            <p class="text-2xl font-bold text-gray-800"><span id="report-total-sum">0.000</span> ر.ع</p>
                        </div>
                        <div class="bg-red-50 p-4 rounded border border-red-100">
                            <p class="text-sm text-red-500">المبلغ المستحق (غير مدفوع)</p>
                            <p class="text-2xl font-bold text-red-700"><span id="report-due-sum">0.000</span> ر.ع</p>
                        </div>
                    </div>

                    <table class="w-full text-right border-collapse">
                        <thead>
                            <tr class="border-b-2 border-gray-300">
                                <th class="py-3 px-2 text-gray-600">التاريخ</th>
                                <th class="py-3 px-2 text-gray-600 filter-col">المورد</th>
                                <th class="py-3 px-2 text-gray-600">السلعة</th>
                                <th class="py-3 px-2 text-gray-600 text-center">الكمية</th>
                                <th class="py-3 px-2 text-gray-600">الإجمالي</th>
                                <th class="py-3 px-2 text-gray-600">الاستحقاق</th>
                                <th class="py-3 px-2 text-gray-600 text-center">الوقت المتبقي</th>
                                <th class="py-3 px-2 text-gray-600 text-center">الحالة</th>
                                <th class="py-3 px-2 text-center no-print">إجراء</th>
                            </tr>
                        </thead>
                        <tbody id="report-table-body" class="divide-y divide-gray-200">
                            <!-- Populated by JS -->
                        </tbody>
                        <tfoot>
                            <tr class="border-t-2 border-gray-300 bg-gray-50 font-bold">
                                <td colspan="4" class="py-4 px-2 text-left pl-8">المجموع الكلي:</td>
                                <td class="py-4 px-2 text-blue-800"><span id="report-footer-total">0.000</span> ر.ع</td>
                                <td colspan="4"></td>
                            </tr>
                        </tfoot>
                    </table>
                </div>
            </div>

            <!-- VIEW: SETTINGS -->
            <div id="view-settings" class="view-section hidden max-w-2xl mx-auto space-y-6">
                <h2 class="text-2xl font-bold text-gray-800 mb-6 flex items-center gap-2">
                    <i data-lucide="settings" class="text-blue-600 w-6 h-6"></i>
                    إدارة البيانات وقاعدة البيانات
                </h2>

                <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-6 space-y-6">
                    <div>
                        <h3 class="font-bold text-lg text-gray-800 mb-2 flex items-center gap-2">
                            <i data-lucide="download" class="text-blue-500 w-5 h-5"></i>
                            تصدير نسخة احتياطية
                        </h3>
                        <p class="text-gray-500 text-sm mb-4">
                            قم بتحميل ملف JSON يحتوي على جميع البيانات. استخدمه لاستعادة البيانات لاحقاً.
                        </p>
                        <button onclick="exportData()" class="w-full bg-green-600 text-white hover:bg-green-700 px-4 py-2 rounded-lg font-medium flex items-center justify-center gap-2">
                            <i data-lucide="download" class="w-4 h-4"></i>
                            تحميل قاعدة البيانات
                        </button>
                    </div>

                    <div class="border-t pt-6">
                        <h3 class="font-bold text-lg text-gray-800 mb-2 flex items-center gap-2">
                            <i data-lucide="upload" class="text-blue-500 w-5 h-5"></i>
                            استيراد نسخة احتياطية
                        </h3>
                        <p class="text-gray-500 text-sm mb-4">
                            استرجع البيانات من ملف سابق. <span class="text-red-500 font-bold">تنبيه: سيتم استبدال البيانات الحالية.</span>
                        </p>
                        <div class="relative">
                            <input type="file" accept=".json" onchange="importData(this)" class="absolute inset-0 w-full h-full opacity-0 cursor-pointer">
                            <button class="w-full border border-gray-300 text-gray-700 hover:bg-gray-50 px-4 py-2 rounded-lg font-medium flex items-center justify-center gap-2">
                                <i data-lucide="upload" class="w-4 h-4"></i>
                                اختر ملف النسخة الاحتياطية
                            </button>
                        </div>
                    </div>

                    <div class="border-t pt-6">
                        <h3 class="font-bold text-lg text-red-600 mb-2 flex items-center gap-2">
                            <i data-lucide="refresh-cw" class="text-red-500 w-5 h-5"></i>
                            إعادة ضبط النظام
                        </h3>
                        <p class="text-gray-500 text-sm mb-4">
                            حذف جميع البيانات الحالية والعودة إلى البيانات الافتراضية.
                        </p>
                        <button onclick="resetData()" class="w-full bg-red-50 text-red-600 hover:bg-red-100 px-4 py-2 rounded-lg font-medium flex items-center justify-center gap-2">
                            <i data-lucide="trash-2" class="w-4 h-4"></i>
                            حذف البيانات وإعادة الضبط
                        </button>
                    </div>
                </div>
            </div>

        </main>
    </div>

    <!-- Application Logic -->
    <script>
        // --- Data Initialization ---
        // تم إفراغ البيانات الافتراضية بناءً على طلب المستخدم
        const defaultSuppliers = [];
        const defaultInvoices = [];

        let suppliers = JSON.parse(localStorage.getItem('billing_suppliers')) || defaultSuppliers;
        let invoices = JSON.parse(localStorage.getItem('billing_invoices')) || defaultInvoices;

        // --- Helper Functions ---
        const saveData = () => {
            localStorage.setItem('billing_suppliers', JSON.stringify(suppliers));
            localStorage.setItem('billing_invoices', JSON.stringify(invoices));
            renderAll();
        };

        const formatCurrency = (amount) => amount.toLocaleString('en-US', { minimumFractionDigits: 3, maximumFractionDigits: 3 }) + ' ' + 'ر.ع';

        const getDaysRemaining = (dueDate) => {
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            const due = new Date(dueDate);
            const diffTime = due - today;
            return Math.ceil(diffTime / (1000 * 60 * 60 * 24));
        };

        const getDefaultDueDate = () => {
            const date = new Date();
            date.setDate(date.getDate() + 30);
            return date.toISOString().split('T')[0];
        };

        // --- UI Rendering ---
        
        function switchTab(tabId) {
            // Hide all views
            document.querySelectorAll('.view-section').forEach(el => el.classList.add('hidden'));
            // Show selected view
            document.getElementById('view-' + tabId).classList.remove('hidden');
            
            // Update sidebar active state
            document.querySelectorAll('.nav-btn').forEach(btn => {
                if(btn.dataset.tab === tabId) {
                    btn.classList.add('text-blue-700', 'bg-blue-50', 'font-bold');
                    btn.classList.remove('text-gray-600', 'hover:bg-gray-50');
                } else {
                    btn.classList.remove('text-blue-700', 'bg-blue-50', 'font-bold');
                    btn.classList.add('text-gray-600', 'hover:bg-gray-50');
                }
            });

            // Refresh data for the view
            if(tabId === 'dashboard') updateDashboard();
            if(tabId === 'suppliers') renderSuppliersList();
            if(tabId === 'reports') updateReport();
            
            // Re-initialize icons
            lucide.createIcons();
        }

        function toggleMobileMenu() {
            const sidebar = document.getElementById('sidebar');
            sidebar.classList.toggle('hidden');
        }

        function calculateTotal() {
            const qty = parseFloat(document.getElementById('inv-qty').value) || 0;
            const price = parseFloat(document.getElementById('inv-price').value) || 0;
            document.getElementById('inv-total-display').textContent = (qty * price).toLocaleString('en-US', { minimumFractionDigits: 3, maximumFractionDigits: 3 });
        }

        function updateDashboard() {
            const totalInvoices = invoices.reduce((sum, inv) => sum + (inv.quantity * inv.price), 0);
            const totalPaid = invoices.filter(i => i.status === 'paid').reduce((sum, inv) => sum + (inv.quantity * inv.price), 0);
            const totalDue = totalInvoices - totalPaid;

            document.getElementById('dash-total').textContent = totalInvoices.toLocaleString('en-US', { minimumFractionDigits: 3, maximumFractionDigits: 3 });
            document.getElementById('dash-paid').textContent = totalPaid.toLocaleString('en-US', { minimumFractionDigits: 3, maximumFractionDigits: 3 });
            document.getElementById('dash-due').textContent = totalDue.toLocaleString('en-US', { minimumFractionDigits: 3, maximumFractionDigits: 3 });
            document.getElementById('header-total-due').textContent = formatCurrency(totalDue);

            const tbody = document.getElementById('dash-table-body');
            tbody.innerHTML = '';
            
            const sortedInvoices = [...invoices].sort((a,b) => new Date(a.dueDate) - new Date(b.dueDate));

            if (sortedInvoices.length === 0) {
                document.getElementById('dash-empty-msg').classList.remove('hidden');
            } else {
                document.getElementById('dash-empty-msg').classList.add('hidden');
                sortedInvoices.forEach(inv => {
                    const supplier = suppliers.find(s => s.id === inv.supplierId);
                    const days = getDaysRemaining(inv.dueDate);
                    const total = inv.quantity * inv.price;
                    
                    let statusHtml = '';
                    if (inv.status === 'paid') {
                        statusHtml = `<span class="flex items-center gap-1 text-green-700 bg-green-100 px-2 py-1 rounded-full text-xs w-fit"><i data-lucide="check-circle" class="w-3 h-3"></i> مدفوع</span>`;
                    } else if (days < 0) {
                        statusHtml = `<span class="flex items-center gap-1 text-red-700 bg-red-100 px-2 py-1 rounded-full text-xs font-bold w-fit animate-pulse"><i data-lucide="alert-triangle" class="w-3 h-3"></i> متأخر ${Math.abs(days)} يوم</span>`;
                    } else if (days === 0) {
                        statusHtml = `<span class="flex items-center gap-1 text-orange-700 bg-orange-100 px-2 py-1 rounded-full text-xs font-bold w-fit"><i data-lucide="clock" class="w-3 h-3"></i> مستحق اليوم</span>`;
                    } else {
                        statusHtml = `<span class="flex items-center gap-1 text-blue-700 bg-blue-100 px-2 py-1 rounded-full text-xs font-bold w-fit"><i data-lucide="clock" class="w-3 h-3"></i> باقي ${days} يوم</span>`;
                    }

                    const row = `
                        <tr class="hover:bg-gray-50 border-b border-gray-100 last:border-0">
                            <td class="p-4 text-gray-600">${inv.date}</td>
                            <td class="p-4 font-medium">${supplier ? supplier.name : 'مورد محذوف'}</td>
                            <td class="p-4">${inv.item}</td>
                            <td class="p-4 font-bold">${formatCurrency(total)}</td>
                            <td class="p-4 text-gray-600">${inv.dueDate}</td>
                            <td class="p-4">${statusHtml}</td>
                        </tr>
                    `;
                    tbody.innerHTML += row;
                });
            }
        }

        function renderSuppliersList() {
            const container = document.getElementById('suppliers-list');
            container.innerHTML = '';
            
            if (suppliers.length === 0) {
                container.innerHTML = '<p class="text-gray-400 text-center py-10">لا يوجد موردين مضافين</p>';
                return;
            }

            suppliers.forEach(supplier => {
                const supplierInvoices = invoices.filter(i => i.supplierId === supplier.id);
                const due = supplierInvoices.filter(i => i.status === 'unpaid')
                              .reduce((sum, i) => sum + (i.price * i.quantity), 0);

                const card = `
                    <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-4 flex flex-col sm:flex-row justify-between items-center gap-4 hover:shadow-md transition-shadow">
                        <div class="flex items-center gap-4 w-full sm:w-auto">
                            <div class="bg-gray-100 p-3 rounded-full text-gray-600">
                                <i data-lucide="users" class="w-6 h-6"></i>
                            </div>
                            <div>
                                <h4 class="font-bold text-lg text-gray-800">${supplier.name}</h4>
                                <p class="text-gray-500 text-sm">${supplier.phone || 'لا يوجد هاتف'}</p>
                            </div>
                        </div>
                        <div class="flex items-center gap-6 w-full sm:w-auto justify-between sm:justify-end">
                            <div class="text-left">
                                <span class="block text-xs text-gray-500">مستحقات</span>
                                <span class="block font-bold ${due > 0 ? 'text-red-600' : 'text-green-600'}">${formatCurrency(due)}</span>
                            </div>
                            <button onclick="deleteSupplier(${supplier.id})" class="p-2 text-red-400 hover:text-red-600 hover:bg-red-50 rounded-full transition-colors" title="حذف المورد">
                                <i data-lucide="trash-2" class="w-5 h-5"></i>
                            </button>
                        </div>
                    </div>
                `;
                container.innerHTML += card;
            });
            lucide.createIcons();
        }

        function populateSupplierSelects() {
            const selects = [document.getElementById('inv-supplier'), document.getElementById('report-supplier-filter')];
            const hasSuppliers = suppliers.length > 0;

            document.getElementById('no-suppliers-msg').classList.toggle('hidden', hasSuppliers);

            // Invoice Select
            const invSelect = document.getElementById('inv-supplier');
            invSelect.innerHTML = '<option value="">-- اختر من القائمة --</option>';
            suppliers.forEach(s => {
                invSelect.innerHTML += `<option value="${s.id}">${s.name}</option>`;
            });

            // Report Select (Keep the first 'all' option)
            const repSelect = document.getElementById('report-supplier-filter');
            const currentVal = repSelect.value;
            repSelect.innerHTML = '<option value="all">جميع الموردين</option>';
            suppliers.forEach(s => {
                repSelect.innerHTML += `<option value="${s.id}">${s.name}</option>`;
            });
            repSelect.value = currentVal;
        }

        function updateReport() {
            const filterId = document.getElementById('report-supplier-filter').value;
            const reportDate = new Date().toLocaleDateString('ar-SA');
            document.getElementById('report-date').textContent = reportDate;

            let filteredInvoices = invoices;
            if (filterId !== 'all') {
                filteredInvoices = invoices.filter(inv => inv.supplierId == filterId);
                const sup = suppliers.find(s => s.id == filterId);
                document.getElementById('report-supplier-name').textContent = sup ? sup.name : '';
                document.getElementById('report-header-filter').classList.remove('hidden');
                // Hide supplier column in print if specific supplier selected
                document.querySelectorAll('.filter-col').forEach(el => el.classList.add('hidden'));
            } else {
                document.getElementById('report-header-filter').classList.add('hidden');
                document.querySelectorAll('.filter-col').forEach(el => el.classList.remove('hidden'));
            }

            const totalSum = filteredInvoices.reduce((sum, inv) => sum + (inv.quantity * inv.price), 0);
            const dueSum = filteredInvoices.filter(i => i.status === 'unpaid').reduce((sum, inv) => sum + (inv.quantity * inv.price), 0);

            document.getElementById('report-total-sum').textContent = totalSum.toLocaleString('en-US', { minimumFractionDigits: 3, maximumFractionDigits: 3 });
            document.getElementById('report-due-sum').textContent = dueSum.toLocaleString('en-US', { minimumFractionDigits: 3, maximumFractionDigits: 3 });
            document.getElementById('report-footer-total').textContent = totalSum.toLocaleString('en-US', { minimumFractionDigits: 3, maximumFractionDigits: 3 });

            const tbody = document.getElementById('report-table-body');
            tbody.innerHTML = '';

            if(filteredInvoices.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" class="text-center py-8 text-gray-400">لا توجد بيانات للعرض</td></tr>';
            } else {
                filteredInvoices.forEach(inv => {
                    const supplier = suppliers.find(s => s.id === inv.supplierId);
                    const total = inv.quantity * inv.price;
                    const days = getDaysRemaining(inv.dueDate);
                    const statusClass = inv.status === 'paid' ? 'bg-green-100 text-green-800 border-green-200' : 'bg-red-100 text-red-800 border-red-200';
                    const statusText = inv.status === 'paid' ? 'تم الدفع' : 'مستحق';
                    
                    let timeRemainingHtml = '';
                    if (inv.status === 'paid') {
                        timeRemainingHtml = '<span class="text-gray-400">-</span>';
                    } else {
                        if (days < 0) {
                            timeRemainingHtml = `<span class="text-red-600 font-bold text-xs">متأخر ${Math.abs(days)} يوم</span>`;
                        } else if (days === 0) {
                            timeRemainingHtml = `<span class="text-orange-600 font-bold text-xs">اليوم</span>`;
                        } else {
                            timeRemainingHtml = `<span class="text-blue-600 text-xs">باقي ${days} يوم</span>`;
                        }
                    }

                    const row = `
                        <tr class="hover:bg-gray-50">
                            <td class="py-3 px-2">${inv.date}</td>
                            ${filterId === 'all' ? `<td class="py-3 px-2 font-medium filter-col">${supplier ? supplier.name : 'محذوف'}</td>` : ''}
                            <td class="py-3 px-2">${inv.item}</td>
                            <td class="py-3 px-2 text-center">${inv.quantity}</td>
                            <td class="py-3 px-2 font-bold">${total.toLocaleString('en-US', { minimumFractionDigits: 3, maximumFractionDigits: 3 })}</td>
                            <td class="py-3 px-2 text-gray-600">${inv.dueDate}</td>
                            <td class="py-3 px-2 text-center">${timeRemainingHtml}</td>
                            <td class="py-3 px-2 text-center">
                                <span class="inline-block px-2 py-1 rounded text-xs border ${statusClass}">${statusText}</span>
                            </td>
                            <td class="py-3 px-2 text-center no-print">
                                <button onclick="toggleInvoiceStatus(${inv.id})" class="p-1 rounded hover:bg-gray-100 text-sm ${inv.status === 'paid' ? 'text-red-500' : 'text-green-500'}">
                                    <i data-lucide="${inv.status === 'paid' ? 'x-circle' : 'check-circle'}" class="w-5 h-5"></i>
                                </button>
                            </td>
                        </tr>
                    `;
                    tbody.innerHTML += row;
                });
            }
            lucide.createIcons();
        }

        // --- Event Listeners & Logic ---

        document.getElementById('supplier-form').addEventListener('submit', (e) => {
            e.preventDefault();
            const name = document.getElementById('sup-name').value;
            const phone = document.getElementById('sup-phone').value;
            
            const id = suppliers.length > 0 ? Math.max(...suppliers.map(s => s.id)) + 1 : 1;
            suppliers.push({ id, name, phone });
            
            e.target.reset();
            saveData();
            alert('تم إضافة المورد بنجاح');
            renderSuppliersList(); // Re-render if on suppliers tab
        });

        document.getElementById('invoice-form').addEventListener('submit', (e) => {
            e.preventDefault();
            const supplierId = parseInt(document.getElementById('inv-supplier').value);
            const item = document.getElementById('inv-item').value;
            const quantity = parseFloat(document.getElementById('inv-qty').value);
            const price = parseFloat(document.getElementById('inv-price').value);
            const date = document.getElementById('inv-date').value;
            const dueDate = document.getElementById('inv-due-date').value;
            const status = document.querySelector('input[name="inv-status"]:checked').value;

            if(!supplierId) { alert('الرجاء اختيار مورد'); return; }

            const id = invoices.length > 0 ? Math.max(...invoices.map(i => i.id)) + 1 : 101;
            invoices.push({ id, supplierId, item, quantity, price, date, dueDate, status });

            // Reset form partly
            document.getElementById('inv-item').value = '';
            document.getElementById('inv-qty').value = '1';
            document.getElementById('inv-price').value = '0';
            calculateTotal();
            
            saveData();
            alert('تم حفظ الفاتورة بنجاح');
        });

        window.deleteSupplier = (id) => {
            const hasInvoices = invoices.some(inv => inv.supplierId === id);
            
            let confirmMessage = 'هل أنت متأكد من حذف هذا المورد؟';
            if (hasInvoices) {
                confirmMessage = 'تنبيه: هذا المورد لديه فواتير مسجلة. سيتم حذف المورد وجميع فواتيره المرتبطة. هل أنت متأكد؟';
            }

            if(confirm(confirmMessage)) {
                // Delete associated invoices first if any
                if (hasInvoices) {
                    invoices = invoices.filter(inv => inv.supplierId !== id);
                }
                // Delete supplier
                suppliers = suppliers.filter(s => s.id !== id);
                saveData();
                alert('تم الحذف بنجاح');
            }
        };

        window.toggleInvoiceStatus = (id) => {
            const inv = invoices.find(i => i.id === id);
            if(inv) {
                inv.status = inv.status === 'paid' ? 'unpaid' : 'paid';
                saveData();
                updateReport(); // Refresh report if active
                updateDashboard(); // Refresh dashboard data
            }
        };

        window.exportData = () => {
            const data = {
                suppliers,
                invoices,
                exportDate: new Date().toISOString(),
                appVersion: "1.0-html"
            };
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `billing_backup_${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        };

        window.importData = (input) => {
            const file = input.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const data = JSON.parse(e.target.result);
                    if (data.suppliers && data.invoices) {
                        if (confirm('سيتم استبدال البيانات الحالية بالبيانات الموجودة في الملف. هل أنت متأكد؟')) {
                            suppliers = data.suppliers;
                            invoices = data.invoices;
                            saveData();
                            alert('تم استرجاع قاعدة البيانات بنجاح!');
                        }
                    } else {
                        alert('الملف غير صالح.');
                    }
                } catch (error) {
                    alert('خطأ في قراءة الملف.');
                }
            };
            reader.readAsText(file);
            input.value = ''; // Reset
        };

        window.resetData = () => {
            if (confirm('تحذير: سيتم حذف جميع البيانات والعودة للوضع الافتراضي. هل أنت متأكد؟')) {
                suppliers = defaultSuppliers;
                invoices = defaultInvoices;
                saveData();
                location.reload();
            }
        };

        function renderAll() {
            populateSupplierSelects();
            updateDashboard();
            renderSuppliersList();
            updateReport();
        }

        // --- Initialization ---
        document.getElementById('inv-date').valueAsDate = new Date();
        document.getElementById('inv-due-date').value = getDefaultDueDate();
        
        // Initial Render
        renderAll();
        lucide.createIcons();

    </script>
</body>
</html>